-- [중요] 이 SQL을 Supabase Dashboard > SQL Editor에 복사해서 실행하세요.

-- 1. 포트폴리오(Portfolios) 테이블 생성
create table if not exists public.portfolios (
  id bigint generated by default as identity primary key,
  title text not null,
  client text,               -- 발주처/클라이언트
  artist text default 'ART HYUN', -- 작가 (협업 시)
  description text,          -- 상세 설명 (HTML)
  location text,             -- 설치 장소
  completion_date date,      -- 완공/완료일
  category text,             -- 카테고리 (공공미술, 벽화, 공공디자인, 아카이브, 기타)
  
  thumbnail_url text,        -- 목록용 썸네일 URL
  images text[],             -- 상세 이미지 URL 배열 (선택사항)
  
  is_visible boolean default true,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 2. 권한 설정 (RLS) - 관리자만 수정 가능, 누구나 조회 가능
alter table public.portfolios enable row level security;

create policy "Portfolios are viewable by everyone."
  on public.portfolios for select using ( true );

create policy "Admins can insert portfolios."
  on public.portfolios for insert with check ( auth.role() = 'authenticated' );

create policy "Admins can update portfolios."
  on public.portfolios for update using ( auth.role() = 'authenticated' );

create policy "Admins can delete portfolios."
  on public.portfolios for delete using ( auth.role() = 'authenticated' );


-- 3. 데이터 마이그레이션 (기존 migrated_posts에서 가져오기)
-- 'portfolio' 타입의 데이터를 자동으로 portfolios 테이블로 옮깁니다.
INSERT INTO public.portfolios (title, description, completion_date, category, created_at, thumbnail_url)
SELECT 
    title,
    content as description,
    created_at::date as completion_date,
    'Archive' as category, -- 초기값은 Archive로 설정
    created_at,
    
    -- 내용(content)에서 첫 번째 이미지 주소(src)를 찾아서 썸네일로 사용
    (regexp_matches(content, 'src="([^"]+)"'))[1] as thumbnail_url
FROM 
    public.migrated_posts 
WHERE 
    type = 'portfolio';

-- 4. 확인
SELECT count(*) FROM public.portfolios;
